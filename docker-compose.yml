version: '2'
services:
  # app:
  #   build: .
  #   command: python manage.py start
  #   container_name: "app"
  #   image: debian/latest
  #   environment:
  #       - ENVIRONMENT=production
  #   links:
  #       - postgres
  #       - redis
  #   depends_on:
  #       - postgres
  #       - redis
  #   ports:
  #     - '8000:8000'
  #   networks:
  #     - network1
  # celery:
  #   build: .
  #   command: celery -A app worker -l info
  #   environment:
  #       - DJANGO_SETTINGS_MODULE=app.settings.production
  #   networks:
  #     - network1
  #   depends_on:
  #     - postgres
  #     - redis
  #   volumes:
  #     - ./data:/data
  #   links:
  #       - postgres
  #       - redis
  celery-beat:
    build: .
    command: celery -A app beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    environment:
        - DJANGO_SETTINGS_MODULE=app.settings.production
    networks:
      - network1
    depends_on:
      - postgres
      - redis
    volumes:
      - ./data:/data
    links:
        - postgres
        - redis
  # https://www.distributedpython.com/2018/10/13/flower-docker/
  flower:
    image: mher/flower
    environment:
    - CELERY_BROKER_URL=redis://redis
    - FLOWER_PORT=8888
    ports:
      - 8888:8888
    networks:
      - network1
  redis:
    hostname: redis
    image: redis:alpine
    ports:
        - 6378:6379
    networks:
      - network1
  postgres:
    image: postgres:11
    shm_size: '2gb'
    environment:
      - POSTGRES_DB=anhd
      - POSTGRES_USER=anhd
    ports:
      - 5678:5432
    networks:
      - network1
volumes:
  pg_vol1:
networks:
  network1:
